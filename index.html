<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ESP32 POWER Monitor</title>

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-pVPDvN6sLm+ZT+jKcKOTz5aWQ0h1X1t5Kp1lmJGKV9nP+0PbBzJGK4xCwTOh9I4UPuQ+dx3xX0XrQ5f+3kd9cw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* Reset & base */
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 0 15px 30px;
        color: #333;
        line-height: 1.4;
      }

      /* App bar */
      header {
        background-color: #007bff;
        color: white;
        padding: 15px 20px;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        border-radius: 0 0 10px 10px;
        position: sticky;
        top: 0;
        z-index: 999;
      }
      header i {
        font-size: 1.8rem;
      }

      /* Container */
      .container {
        max-width: 700px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 20px 25px;
        box-shadow: 0 4px 15px rgb(0 0 0 / 0.1);
      }

      /* Title */
      h2 {
        text-align: center;
        margin-bottom: 25px;
        color: #222;
        font-size: 1.8rem;
      }

      /* Monitoring items */
      .item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        font-size: 1.15rem;
      }
      .item:last-child {
        border-bottom: none;
      }
      .item i {
        color: #007bff;
        min-width: 30px;
        font-size: 1.5rem;
        text-align: center;
      }
      .value {
        font-weight: 700;
        margin-left: auto;
        color: #222;
        min-width: 70px;
        text-align: right;
        white-space: nowrap;
      }

      /* Chart container */
      .chart-container {
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
      }

      /* Responsive Styles */
      @media (max-width: 768px) {
        .container {
          max-width: 100%;
          padding: 15px 20px;
          border-radius: 0;
          box-shadow: none;
        }
        h2 {
          font-size: 1.5rem;
        }
        .item {
          font-size: 1.1rem;
          gap: 10px;
          padding: 10px 0;
        }
        header {
          font-size: 1.3rem;
          padding: 12px 15px;
          gap: 8px;
        }
        header i {
          font-size: 1.4rem;
        }
        .value {
          min-width: 60px;
          font-size: 1rem;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 0 10px 20px;
        }
        .item {
          flex-wrap: wrap;
          font-size: 1rem;
          gap: 8px;
          padding: 8px 0;
        }
        .value {
          margin-left: 0;
          min-width: auto;
          width: 100%;
          text-align: left;
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <i class="fa-solid fa-bolt"></i>
      ESP32 Power Monitor
    </header>

    <div class="container">
      <h2>Data Monitoring dari Firebase</h2>

      <div class="item">
        <i class="fa-solid fa-bolt"></i>
        Voltage
        <span class="value" id="volt">0 V</span>
      </div>

      <div class="item">
        <i class="fa-solid fa-plug"></i>
        Current
        <span class="value" id="curr">0 A</span>
      </div>

      <div class="item">
        <i class="fa-solid fa-battery-three-quarters"></i>
        Power
        <span class="value" id="pow">0 W</span>
      </div>

      <div class="item">
        <i class="fa-solid fa-clock"></i>
        Energy
        <span class="value" id="ener">0 kWh</span>
      </div>

      <div class="item">
        <i class="fa-solid fa-wave-square"></i>
        Frequency
        <span class="value" id="freq">0 Hz</span>
      </div>

      <div class="item">
        <i class="fa-solid fa-sliders"></i>
        Power Factor
        <span class="value" id="pf">0</span>
      </div>

      <!-- Chart for Voltage -->
      <div class="chart-container">
        <canvas id="voltageChart" height="140"></canvas>
      </div>
    </div>

    <!-- Firebase v9 Modular Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAMqxkBgNXzF4aB8dk5DdcUdY8XRL-9rNI",
        authDomain: "home-25fd1.firebaseapp.com",
        databaseURL: "https://home-25fd1-default-rtdb.firebaseio.com",
        projectId: "home-25fd1",
        storageBucket: "home-25fd1.appspot.com",
        messagingSenderId: "893440021332",
        appId: "1:893440021332:web:bcfc9f399146df35696ec1",
        measurementId: "G-G1EJP0CJH3",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      function updateValueWithUnit(id, path, unit) {
        const dbRef = ref(db, path);
        onValue(dbRef, (snapshot) => {
          const data = snapshot.val();
          const valueText = data !== null ? data : 0;
          document.getElementById(id).innerText = `${valueText} ${unit}`;
        });
      }

      updateValueWithUnit("volt", "monitoring/voltage", "V");
      updateValueWithUnit("curr", "monitoring/current", "A");
      updateValueWithUnit("pow", "monitoring/power", "W");
      updateValueWithUnit("ener", "monitoring/energy", "kWh");
      updateValueWithUnit("freq", "monitoring/frequency", "Hz");
      updateValueWithUnit("pf", "monitoring/pf", "");

      // Chart.js setup
      const ctx = document.getElementById("voltageChart").getContext("2d");
      const maxDataPoints = 30;
      const voltageData = {
        labels: [],
        datasets: [
          {
            label: "Voltage (V)",
            data: [],
            borderColor: "#007bff",
            backgroundColor: "rgba(0,123,255,0.2)",
            fill: true,
            tension: 0.3,
            pointRadius: 2,
          },
        ],
      };

      const config = {
        type: "line",
        data: voltageData,
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              display: false,
            },
            y: {
              beginAtZero: true,
              suggestedMax: 250,
            },
          },
          plugins: {
            legend: {
              display: true,
              position: "top",
              labels: {
                color: "#007bff",
                font: { weight: "bold" },
              },
            },
          },
        },
      };

      const voltageChart = new Chart(ctx, config);

      const voltageRef = ref(db, "monitoring/voltage");
      onValue(voltageRef, (snapshot) => {
        const voltage = snapshot.val();
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();

        if (voltage !== null) {
          if (voltageData.labels.length >= maxDataPoints) {
            voltageData.labels.shift();
            voltageData.datasets[0].data.shift();
          }
          voltageData.labels.push(timeLabel);
          voltageData.datasets[0].data.push(voltage);

          voltageChart.update();
        }
      });
    </script>
  </body>
</html>
